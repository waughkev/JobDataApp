<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Tailor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: vertical;
            min-height: 150px;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .output-textarea {
            min-height: 300px; /* Larger for generated content */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }
        .message-box {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            color: #2b6cb0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div id="loading" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="w-full bg-gray-800 p-4 shadow-md">
        <nav class="container mx-auto flex justify-center space-x-8">
            <a href="index.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Job Editor</a>
            <a href="tailor.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Resume Tailor</a>
            <a href="coverletter.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Cover Letters</a>
            <a href="cover_letter_writer.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">AI Cover Letter</a>
        </nav>
    </div>

    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI-Powered Resume Tailor</h1>

        <p class="text-sm text-gray-600 mb-4 text-center">Your User ID: <span id="userIdDisplay" class="font-semibold text-gray-800">Loading...</span></p>

        <div id="message-box" class="hidden message-box mb-4" role="alert">
            <span id="message-content"></span>
        </div>

        <h2 class="text-xl font-semibold text-gray-700 mb-3">Job Description:</h2>
        <textarea id="jobDescriptionInput" placeholder="Paste the full job description here. Use **double asterisks** for important keywords (e.g., **project management**, **Agile**)." class="mb-4"></textarea>

        <button id="tailorResumeBtn" class="btn btn-primary mb-6">Generate Tailored Resume Content</button>

        <h2 class="text-xl font-semibold text-gray-700 mb-3">Generated Tailored Resume Content:</h2>
        <textarea id="tailoredResumeOutput" class="output-textarea" readonly placeholder="Your AI-generated tailored resume content will appear here."></textarea>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration - MUST BE THE SAME AS YOUR OTHER PAGES
        const firebaseConfig = {
            apiKey: "AIzaSyDwkW-MVF3aKqI-F-xGP0XA1uvcsPeanSo",
            authDomain: "jobdata-c7f32.firebaseapp.com",
            projectId: "jobdata-c7f32",
            storageBucket: "jobdata-c7f32.firebasestorage.app",
            messagingSenderId: "534346265582",
            appId: "1:534346265582:web:40af2358628940ced154ff"
        };

        const APP_ID_FOR_HEROKU = firebaseConfig.projectId; 

        // Firebase instances
        let app;
        let db;
        let auth;
        let userId = null; 
        let jobData = []; 

        const loadingOverlay = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const jobDescriptionInput = document.getElementById('jobDescriptionInput');
        const tailoredResumeOutput = document.getElementById('tailoredResumeOutput');
        const tailorResumeBtn = document.getElementById('tailorResumeBtn');

        // --- Utility Functions ---
        function showLoading() {
            tailoredResumeOutput.value = "Generating tailored resume content... This may take a moment.";
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            messageContent.textContent = message;
            messageBox.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100', 'border-blue-400', 'border-green-400', 'border-red-400', 'text-blue-700', 'text-green-700', 'text-red-700');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden'); 
            }, 5000);
        }

        // Simple tokenizer 
        function tokenizeAndFilter(text) {
            const stopwords = new Set([
                "a", "an", "and", "are", "as", "at", "be", "but", "by", "for", "if", "in", "into", "is", "it",
                "no", "not", "of", "on", "or", "such", "that", "the", "their", "then", "there", "these", "they",
                "this", "to", "was", "will", "with", "from", "you", "your", "we", "our", "us", "i", "my", "me",
                "he", "she", "it", "him", "her", "his", "hers", "its", "they", "them", "their", "theirs", "what",
                "when", "where", "who", "whom", "whose", "why", "how", "had", "has", "have", "do", "does", "did",
                "can", "could", "would", "should", "may", "might", "must", "about", "above", "across", "after",
                "against", "along", "among", "around", "before", "behind", "below", "beneath", "beside", "between",
                "beyond", "during", "except", "inside", "like", "near", "off", "on", "onto", "out", "outside",
                "over", "past", "round", "since", "through", "to", "under", "up", "upon", "within", "without",
                "via", "also", "very", "much", "more", "most", "less", "least", "just", "only", "even", "indeed",
                "actually", "really", "so", "too", "well", "away", "back", "down", "forward", "here", "in", "off",
                "on", "out", "over", "still", "then", "there", "under", "up", "when", "where", "while", "why", "yet",
                "experience", "responsibilities", "skills", "ability", "proficient", "strong", "proven", "demonstrated",
                "manage", "lead", "develop", "implement", "create", "drive", "optimize", "support", "collaborate"
            ]);
            return text.toLowerCase()
                       .replace(/[^a-z0-9\s]/g, '') 
                       .split(/\s+/) 
                       .filter(word => word.length > 2 && !stopwords.has(word)); 
        }

        // --- Firebase Initialization and Data Loading ---
        function getJobCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore DB or User ID not initialized.");
                return null;
            }
            return collection(db, `artifacts/${APP_ID_FOR_HEROKU}/users/${userId}/jobExperience`);
        }

        async function initializeFirebaseAndLoadData() {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("User signed in:", userId);
                        onSnapshot(query(getJobCollectionRef()), (snapshot) => {
                            jobData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log(`Loaded ${jobData.length} job experiences.`);
                            showMessage(`Loaded ${jobData.length} job experiences from Firestore.`, 'info');
                            hideLoading();
                        }, (error) => {
                            showMessage('Error fetching job experiences: ' + error.message, 'error');
                            console.error("Error listening to Firestore: ", error);
                            hideLoading();
                        });
                    } else {
                        console.log("User not signed in. Attempting anonymous authentication...");
                        userIdDisplay.textContent = 'Authenticating anonymously...';
                        try {
                            const anonymousUserCredential = await signInAnonymously(auth);
                            userId = anonymousUserCredential.user.uid;
                            userIdDisplay.textContent = userId;
                            console.log("Signed in anonymously:", userId);
                            onSnapshot(query(getJobCollectionRef()), (snapshot) => {
                                jobData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                console.log(`Loaded ${jobData.length} job experiences.`);
                                showMessage(`Loaded ${jobData.length} job experiences from Firestore.`, 'success');
                                hideLoading();
                            }, (error) => {
                                showMessage('Error fetching job experiences: ' + error.message, 'error');
                                console.error("Error listening to Firestore: ", error);
                                hideLoading();
                            });
                        } catch (error) {
                            showMessage('Anonymous authentication failed: ' + error.message, 'error');
                            console.error("Firebase authentication error:", error);
                            userIdDisplay.textContent = 'Authentication Failed'; 
                            hideLoading(); 
                        }
                    }
                });
            } catch (error) {
                showMessage('Error initializing Firebase: ' + error.message, 'error');
                console.error("Firebase initialization error:", error);
                hideLoading();
            }
        }

        // --- Resume Tailoring Logic with AI ---
        async function tailorResume() {
            showLoading();
            const jobDescriptionRaw = jobDescriptionInput.value.trim();

            if (!jobDescriptionRaw) {
                showMessage("Please paste a job description to generate tailored resume content.", "info");
                hideLoading();
                return;
            }

            if (jobData.length === 0) {
                showMessage("No job experiences loaded. Please add some in the Job Editor page first.", "info");
                hideLoading();
                return;
            }

            // --- 1. Identify Most Relevant Job Experiences ---
            const weightedRegex = /\*\*([a-zA-Z0-9\s]+?)\*\*/g;
            let match;
            const rawWeightedKeywords = [];
            let cleanJobDescription = jobDescriptionRaw;

            while ((match = weightedRegex.exec(jobDescriptionRaw)) !== null) {
                rawWeightedKeywords.push(match[1]); 
                cleanJobDescription = cleanJobDescription.replace(match[0], match[1]); 
            }

            const weightedJobDescWords = new Set(tokenizeAndFilter(rawWeightedKeywords.join(' ')));
            const normalJobDescWords = new Set(tokenizeAndFilter(cleanJobDescription));
            const allJobDescKeywords = new Set([...weightedJobDescWords, ...normalJobDescWords]);

            const scoredJobData = [];
            jobData.forEach(job => {
                let jobScore = 0;
                const allJobContentTokens = new Set();
                allJobContentTokens.add(...tokenizeAndFilter(job["Job Skills"] || ''));
                allJobContentTokens.add(...tokenizeAndFilter(job["Job Description"] || ''));

                (job.projects || []).forEach(subproject => {
                    allJobContentTokens.add(...tokenizeAndFilter(subproject.subprojectSkills || ''));
                    allJobContentTokens.add(...tokenizeAndFilter(subproject.subprojectDescription || ''));
                    allJobContentTokens.add(...tokenizeAndFilter(subproject.subprojectRole || ''));
                    allJobContentTokens.add(...tokenizeAndFilter(subproject.subprojectName || ''));
                });

                allJobDescKeywords.forEach(keyword => {
                    if (allJobContentTokens.has(keyword)) {
                        jobScore += weightedJobDescWords.has(keyword) ? 5 : 2; 
                    }
                });
                if (jobScore > 0) { 
                    scoredJobData.push({ job: job, score: jobScore });
                }
            });
            scoredJobData.sort((a, b) => b.score - a.score); 
            const topRelevantJobs = scoredJobData.slice(0, 3); // Top 3 relevant jobs for the AI

            let relevantExperienceString = '';
            if (topRelevantJobs.length > 0) {
                relevantExperienceString = "\n\n**My Relevant Job Experiences (detailed):**\n";
                topRelevantJobs.forEach(item => {
                    relevantExperienceString += `- **Job: ${item.job["Job Name"]}** at **${item.job["Job Company"]}** (${item.job["Job Date Start"]} - ${item.job["Job Date End"]})\n`;
                    if (item.job["Job Description"]) {
                        relevantExperienceString += `  Overall Responsibilities/Achievements: ${item.job["Job Description"]}\n`;
                    }
                    if (item.job["Job Skills"]) {
                        relevantExperienceString += `  Overall Skills: ${item.job["Job Skills"]}\n`;
                    }
                    (item.job.projects || []).forEach(subproject => {
                        relevantExperienceString += `  - Subproject: "${subproject.subprojectName || 'N/A'}", Role: "${subproject.subprojectRole || 'N/A'}" (${subproject.subprojectDateStart || ''} - ${subproject.subprojectDateEnd || ''})\n`;
                        if (subproject.subprojectDescription) {
                            relevantExperienceString += `    Description: ${subproject.subprojectDescription}\n`;
                        }
                        if (subproject.subprojectSkills) {
                            relevantExperienceString += `    Skills: ${subproject.subprojectSkills}\n`;
                        }
                    });
                    relevantExperienceString += '\n'; 
                });
            } else {
                relevantExperienceString = "\n\nNo highly relevant job experiences found based on the job description. The AI will try to use general information.";
            }

            // --- 2. Construct LLM Prompt ---
            let prompt = `You are an expert resume writer. Your task is to draft concise and impactful bullet points for a resume's "Experience" section, specifically tailoring them to a given job description using provided background information.`;
            prompt += `\n\n**Job Description:**\n${jobDescriptionRaw}`;
            prompt += `\n\n${relevantExperienceString}`;
            
            prompt += `\n\n**Instructions for Generating Resume Bullet Points:**`;
            prompt += `\n- Generate 3-5 bullet points for each relevant job experience from "My Relevant Job Experiences."`;
            prompt += `\n- Focus on quantifiable achievements and responsibilities that directly align with the job description.`;
            prompt += `\n- Use strong action verbs at the beginning of each bullet point.`;
            prompt += `\n- Synthesize information; do not simply copy-paste sentences.`;
            prompt += `\n- Clearly demonstrate how my skills and experience are a direct match for the requirements in the job description.`;
            prompt += `\n- Include relevant skills mentioned in my background at the end of the section in a comma-separated list, if applicable.`;
            prompt += `\n- Format the output clearly. For each job, provide the "Job Name" and "Job Company" followed by bullet points. Then, if applicable, provide a "Relevant Skills" section.`;

            // --- 3. Call LLM API ---
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyDwkW-MVF3aKqI-F-xGP0XA1uvcsPeanSo"; // <<< IMPORTANT: REPLACE WITH YOUR ACTUAL API KEY
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    tailoredResumeOutput.value = generatedText;
                    showMessage('Tailored resume content generated successfully!', 'success');
                } else {
                    tailoredResumeOutput.value = "Failed to generate tailored resume content. The AI response was empty or malformed.";
                    showMessage('AI generation failed. Please try again.', 'error');
                    console.error("AI generation failed:", result);
                }
            } catch (error) {
                tailoredResumeOutput.value = "An error occurred while communicating with the AI. Please check your network connection or try again later.";
                showMessage('Network or API error: ' + error.message, 'error');
                console.error("Fetch error:", error);
            } finally {
                hideLoading();
            }
        }

        tailorResumeBtn.addEventListener('click', tailorResume);

        window.onload = initializeFirebaseAndLoadData;
    </script>
</body>
</html>
