<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cover Letter Writer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: vertical;
            min-height: 150px;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .output-textarea {
            min-height: 300px; /* Larger for generated content */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }
        .message-box {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            color: #2b6cb0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div id="loading" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="w-full bg-gray-800 p-4 shadow-md">
        <nav class="container mx-auto flex justify-center space-x-8">
            <a href="index.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Job Editor</a>
            <a href="tailor.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Resume Tailor</a>
            <a href="coverletter.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">Cover Letters</a>
            <a href="cover_letter_writer.html" class="text-black hover:text-indigo-300 font-medium transition duration-300">AI Cover Letter</a>
        </nav>
    </div>

    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Cover Letter Writer</h1>

        <p class="text-sm text-gray-600 mb-4 text-center">Your User ID: <span id="userIdDisplay" class="font-semibold text-gray-800">Loading...</span></p>

        <div id="message-box" class="hidden message-box mb-4" role="alert">
            <span id="message-content"></span>
        </div>

        <h2 class="text-xl font-semibold text-gray-700 mb-3">Job Description:</h2>
        <textarea id="jobDescriptionInput" placeholder="Paste the full job description here. Use **double asterisks** for important keywords (e.g., **project management**, **Agile**)." class="mb-4"></textarea>

        <button id="generateCoverLetterBtn" class="btn btn-primary mb-6">Generate Cover Letter Draft</button>

        <h2 class="text-xl font-semibold text-gray-700 mb-3">Generated Cover Letter Draft:</h2>
        <textarea id="generatedCoverLetterOutput" class="output-textarea" readonly placeholder="Your AI-generated cover letter draft will appear here."></textarea>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration - MUST BE THE SAME AS YOUR OTHER PAGES
        const firebaseConfig = {
            apiKey: "AIzaSyDwkW-MVF3aKqI-F-xGP0XA1uvcsPeanSo",
            authDomain: "jobdata-c7f32.firebaseapp.com",
            projectId: "jobdata-c7f32",
            storageBucket: "jobdata-c7f32.firebasestorage.app",
            messagingSenderId: "534346265582",
            appId: "1:534346265582:web:40af2358628940ced154ff"
        };

        const APP_ID_FOR_HEROKU = firebaseConfig.projectId; 

        // Firebase instances
        let app;
        let db;
        let auth;
        let userId = null; 
        let jobData = []; // To store job experiences
        let coverLettersData = []; // To store past cover letters

        const loadingOverlay = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const jobDescriptionInput = document.getElementById('jobDescriptionInput');
        const generatedCoverLetterOutput = document.getElementById('generatedCoverLetterOutput');
        const generateCoverLetterBtn = document.getElementById('generateCoverLetterBtn');

        // --- Utility Functions ---
        function showLoading() {
            generatedCoverLetterOutput.value = "Generating cover letter draft... This may take a moment.";
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            messageContent.textContent = message;
            messageBox.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100', 'border-blue-400', 'border-green-400', 'border-red-400', 'text-blue-700', 'text-green-700', 'text-red-700');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden'); 
            }, 5000);
        }

        // Simple tokenizer (copied from tailor.html for consistency)
        function tokenizeAndFilter(text) {
            const stopwords = new Set([
                "a", "an", "and", "are", "as", "at", "be", "but", "by", "for", "if", "in", "into", "is", "it",
                "no", "not", "of", "on", "or", "such", "that", "the", "their", "then", "there", "these", "they",
                "this", "to", "was", "will", "with", "from", "you", "your", "we", "our", "us", "i", "my", "me",
                "he", "she", "it", "him", "her", "his", "hers", "its", "they", "them", "their", "theirs", "what",
                "when", "where", "who", "whom", "whose", "why", "how", "had", "has", "have", "do", "does", "did",
                "can", "could", "would", "should", "may", "might", "must", "about", "above", "across", "after",
                "against", "along", "among", "around", "before", "behind", "below", "beneath", "beside", "between",
                "beyond", "during", "except", "inside", "like", "near", "off", "on", "onto", "out", "outside",
                "over", "past", "round", "since", "through", "to", "under", "up", "upon", "within", "without",
                "via", "also", "very", "much", "more", "most", "less", "least", "just", "only", "even", "indeed",
                "actually", "really", "so", "too", "well", "away", "back", "down", "forward", "here", "in", "off",
                "on", "out", "over", "still", "then", "there", "under", "up", "when", "where", "while", "why", "yet",
                "experience", "responsibilities", "skills", "ability", "proficient", "strong", "proven", "demonstrated",
                "manage", "lead", "develop", "implement", "create", "drive", "optimize", "support", "collaborate"
            ]);
            return text.toLowerCase()
                       .replace(/[^a-z0-9\s]/g, '') 
                       .split(/\s+/) 
                       .filter(word => word.length > 2 && !stopwords.has(word)); 
        }

        // --- Firebase Initialization and Data Loading ---
        function getJobCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore DB or User ID not initialized.");
                return null;
            }
            return collection(db, `artifacts/${APP_ID_FOR_HEROKU}/users/${userId}/jobExperience`);
        }

        function getCoverLettersCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore DB or User ID not initialized.");
                return null;
            }
            return collection(db, `artifacts/${APP_ID_FOR_HEROKU}/users/${userId}/coverLetters`);
        }

        async function initializeFirebaseAndLoadData() {
            showLoading(); // Show loading initially
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("User signed in:", userId);

                        // Load both job experiences and cover letters
                        await Promise.all([
                            new Promise(resolve => onSnapshot(query(getJobCollectionRef()), (snapshot) => {
                                jobData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                console.log(`Loaded ${jobData.length} job experiences.`);
                                resolve();
                            }, (error) => { console.error("Error loading job experiences:", error); resolve(); })),
                            new Promise(resolve => onSnapshot(query(getCoverLettersCollectionRef()), (snapshot) => {
                                coverLettersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                console.log(`Loaded ${coverLettersData.length} cover letters.`);
                                resolve();
                            }, (error) => { console.error("Error loading cover letters:", error); resolve(); }))
                        ]);
                        showMessage('All data synchronized with cloud.', 'info');
                        hideLoading(); // Hide loading once all data is loaded
                    } else {
                        console.log("User not signed in. Attempting anonymous authentication...");
                        userIdDisplay.textContent = 'Authenticating anonymously...';
                        try {
                            const anonymousUserCredential = await signInAnonymously(auth);
                            userId = anonymousUserCredential.user.uid;
                            userIdDisplay.textContent = userId;
                            console.log("Signed in anonymously:", userId);
                            
                            // Load data after anonymous sign-in
                            await Promise.all([
                                new Promise(resolve => onSnapshot(query(getJobCollectionRef()), (snapshot) => {
                                    jobData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    console.log(`Loaded ${jobData.length} job experiences.`);
                                    resolve();
                                }, (error) => { console.error("Error loading job experiences:", error); resolve(); })),
                                new Promise(resolve => onSnapshot(query(getCoverLettersCollectionRef()), (snapshot) => {
                                    coverLettersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    console.log(`Loaded ${coverLettersData.length} cover letters.`);
                                    resolve();
                                }, (error) => { console.error("Error loading cover letters:", error); resolve(); }))
                            ]);
                            showMessage('All data synchronized with cloud.', 'success');
                            hideLoading();
                        } catch (error) {
                            showMessage('Authentication failed: ' + error.message, 'error');
                            console.error("Firebase authentication error:", error);
                            userIdDisplay.textContent = 'Authentication Failed'; 
                            hideLoading(); 
                        }
                    }
                });
            } catch (error) {
                showMessage('Error initializing Firebase: ' + error.message, 'error');
                console.error("Firebase initialization error:", error);
                hideLoading();
            }
        }


        // --- Cover Letter Generation Logic ---

        async function generateCoverLetter() {
            showLoading();
            const jobDescriptionRaw = jobDescriptionInput.value.trim();

            if (!jobDescriptionRaw) {
                showMessage("Please paste a job description to generate a cover letter.", "info");
                hideLoading();
                return;
            }

            if (jobData.length === 0 && coverLettersData.length === 0) {
                showMessage("No job experiences or past cover letters loaded. Please add some data first.", "info");
                hideLoading();
                return;
            }

            // Extract weighted keywords from job description
            const weightedRegex = /\*\*([a-zA-Z0-9\s]+?)\*\*/g;
            let match;
            const rawWeightedKeywords = [];
            let cleanJobDescription = jobDescriptionRaw;

            while ((match = weightedRegex.exec(jobDescriptionRaw)) !== null) {
                rawWeightedKeywords.push(match[1]); 
                cleanJobDescription = cleanJobDescription.replace(match[0], match[1]); 
            }

            const weightedJobDescWords = new Set(tokenizeAndFilter(rawWeightedKeywords.join(' ')));
            const normalJobDescWords = new Set(tokenizeAndFilter(cleanJobDescription));
            const allJobDescKeywords = new Set([...weightedJobDescWords, ...normalJobDescWords]);

            // --- 1. Identify Most Relevant Job Experiences ---
            const scoredJobData = [];
            jobData.forEach(job => {
                let jobScore = 0;
                const jobSkillsSet = new Set(tokenizeAndFilter(job["Job Skills"] || ''));
                const jobDescriptionContentSet = new Set(tokenizeAndFilter(job["Job Description"] || ''));

                allJobDescKeywords.forEach(keyword => {
                    if (jobSkillsSet.has(keyword)) {
                        jobScore += weightedJobDescWords.has(keyword) ? 5 : 2; 
                    } else if (jobDescriptionContentSet.has(keyword)) {
                        jobScore += weightedJobDescWords.has(keyword) ? 3 : 1; 
                    }
                });
                if (jobScore > 0) { // Only consider jobs with at least one match
                    scoredJobData.push({ job: job, score: jobScore });
                }
            });
            scoredJobData.sort((a, b) => b.score - a.score); // Sort by relevance
            const topRelevantJobs = scoredJobData.slice(0, 3); // Take top 3 relevant jobs

            let relevantExperienceString = '';
            if (topRelevantJobs.length > 0) {
                relevantExperienceString = "\n\nMy most relevant past experiences include:\n";
                topRelevantJobs.forEach(item => {
                    relevantExperienceString += `- **${item.job["Job Name"]}** at ${item.job["Job Company"]}: ${item.job["Job Description"].substring(0, 100)}...\n`;
                    if (item.job["Job Skills"]) {
                        relevantExperienceString += `  Skills: ${item.job["Job Skills"]}\n`;
                    }
                });
            }

            // --- 2. Identify Most Relevant Past Cover Letters ---
            const scoredCoverLetters = [];
            coverLettersData.forEach(cl => {
                let clScore = 0;
                const clContentWords = new Set(tokenizeAndFilter(cl.content || ''));
                const clTitleWords = new Set(tokenizeAndFilter(cl.title || ''));

                allJobDescKeywords.forEach(keyword => {
                    if (clContentWords.has(keyword)) {
                        clScore += weightedJobDescWords.has(keyword) ? 3 : 1; 
                    }
                    if (clTitleWords.has(keyword)) { // Give extra weight if keyword is in title
                        clScore += weightedJobDescWords.has(keyword) ? 2 : 1;
                    }
                });
                if (clScore > 0) {
                    scoredCoverLetters.push({ cl: cl, score: clScore });
                }
            });
            scoredCoverLetters.sort((a, b) => b.score - a.score);
            const topRelevantCoverLetters = scoredCoverLetters.slice(0, 2); // Take top 2 relevant cover letters

            let relevantCoverLettersString = '';
            if (topRelevantCoverLetters.length > 0) {
                relevantCoverLettersString = "\n\nFor inspiration, here are snippets from my past cover letters that align with this role:\n";
                topRelevantCoverLetters.forEach(item => {
                    relevantCoverLettersString += `- Title: "${item.cl.title}"\n  Snippet: ${item.cl.content.substring(0, 200)}...\n`; // Truncate for brevity
                });
            }

            // --- 3. Construct LLM Prompt ---
            let prompt = `You are an expert career coach and resume writer. Your task is to draft a professional and compelling cover letter for a job application.`;
            prompt += `\n\n**Job Description:**\n${jobDescriptionRaw}`;
            prompt += `\n\n**My Background Information:**`;
            prompt += relevantExperienceString;
            prompt += relevantCoverLettersString;
            prompt += `\n\nDraft a concise and impactful cover letter (around 3-4 paragraphs) that directly addresses the requirements of the job description using my provided background information. Highlight how my skills and experiences make me an ideal candidate. Focus on specific achievements and quantifiable results where possible. Maintain a professional, confident, and enthusiastic tone. Do not just copy-paste text; synthesize and adapt it. Start directly with the salutation "Dear Hiring Manager,". End with a professional closing.`;

            // --- 4. Call LLM API ---
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    generatedCoverLetterOutput.value = generatedText;
                    showMessage('Cover letter draft generated successfully!', 'success');
                } else {
                    generatedCoverLetterOutput.value = "Failed to generate cover letter. The AI response was empty or malformed.";
                    showMessage('AI generation failed. Please try again.', 'error');
                    console.error("AI generation failed:", result);
                }
            } catch (error) {
                generatedCoverLetterOutput.value = "An error occurred while communicating with the AI. Please check your network connection or try again later.";
                showMessage('Network or API error: ' + error.message, 'error');
                console.error("Fetch error:", error);
            } finally {
                hideLoading();
            }
        }

        // Event Listeners
        generateCoverLetterBtn.addEventListener('click', generateCoverLetter);

        // Initialize Firebase and load data when the page loads
        window.onload = initializeFirebaseAndLoadData;
    </script>
</body>
</html>
o